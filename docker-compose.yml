services:
  # FastAPI Application Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcloud-credentials.json
      - PYTHONPATH=/app/src
    depends_on:
      - chroma
    volumes:
      - ./reviews.jsonl:/app/reviews.jsonl
      - ./.processed_s3_files.log:/app/.processed_s3_files.log
      - ./gcloud-credentials.json:/app/gcloud-credentials.json:ro

  # Background Worker Service for Data Pipelines
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: tail -f /dev/null
    environment:
      - CHROMA_HOST=chroma
      - CHROMA_PORT=8000
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcloud-credentials.json
      - PYTHONPATH=/app/src
    depends_on:
      - chroma
    volumes:
      - ./reviews.jsonl:/app/reviews.jsonl
      - ./.processed_s3_files.log:/app/.processed_s3_files.log
      - ./gcloud-credentials.json:/app/gcloud-credentials.json:ro
      # Mount the local AWS credentials directory into the container.
      # The '~' is a shortcut for your home directory.
      # The ':ro' flag makes it read-only for extra security.
      - ~/.aws:/home/appuser/.aws:ro

  # ChromaDB Vector Database Service
  chroma:
    image: chromadb/chroma:0.5.0
    volumes:
      - chroma_data:/chroma/.chroma/index

volumes:
  chroma_data:
