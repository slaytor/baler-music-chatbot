services:
  # FastAPI Application Service
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - PYTHONPATH=/app/src
      - DB_PROVIDER=CLOUD # Assuming prod app uses cloud DB
      - CHROMA_CLOUD_API_KEY=${CHROMA_CLOUD_API_KEY}
      - CHROMA_CLOUD_TENANT=${CHROMA_CLOUD_TENANT}
      - CHROMA_CLOUD_DATABASE=${CHROMA_CLOUD_DATABASE}
      - LLM_PROVIDER=OLLAMA
      - OLLAMA_API_URL=http://host.docker.internal:11434/api/generate
    volumes:
      - ./reviews.jsonl:/app/reviews.jsonl
      - ./.processed_s3_files.log:/app/.processed_s3_files.log
      - ./gcloud-credentials.json:/app/gcloud-credentials.json:ro

  # Background Worker Service for Data Pipelines
  worker:
    build:
      context: .
      dockerfile: Dockerfile
    command: tail -f /dev/null
    environment:
      - PYTHONPATH=/app/src
      - DB_PROVIDER=CLOUD
      - CHROMA_CLOUD_API_KEY=${CHROMA_CLOUD_API_KEY}
      - CHROMA_CLOUD_TENANT=${CHROMA_CLOUD_TENANT}
      - CHROMA_CLOUD_DATABASE=${CHROMA_CLOUD_DATABASE}
      - LLM_PROVIDER=OLLAMA
      - OLLAMA_API_URL=http://host.docker.internal:11434/api/generate
    volumes:
      - ./reviews.jsonl:/app/reviews.jsonl
      - ./.processed_s3_files.log:/app/.processed_s3_files.log
      - ./gcloud-credentials.json:/app/gcloud-credentials.json:ro
      - ~/.aws:/home/appuser/.aws:ro

  # ChromaDB Vector Database Service (for local dev only)
  chroma:
    image: chromadb/chroma:latest
    ports:
      - "8000:8000"
    volumes:
      - ./chroma_db:/chroma/.chroma/index
